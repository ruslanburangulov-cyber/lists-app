<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ITS Work Watch ‚Äî –°–ø–∏—Å–∫–∏</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --brand-blue:#0047BB;
      --brand-teal:#00C5B5;
    }
    body { -webkit-tap-highlight-color: transparent; }
    .x-scroll { -webkit-overflow-scrolling: touch; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">

<header class="sticky top-0 z-20 bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-6xl mx-auto px-3 sm:px-4">
    <div class="h-14 flex items-center gap-3">
      <div class="text-lg font-bold" style="color:var(--brand-blue)">
        ITS Work Watch
      </div>
      <div class="flex-1"></div>
      <div class="md:hidden text-xl">‚ò∞</div>
    </div>

    <div class="pb-3 space-y-2">
      <div class="grid grid-cols-3 gap-2">
        <button id="tab1" class="h-10 rounded-xl text-sm font-semibold border">–ì—Ä—É–ø–ø–∞ 1</button>
        <button id="tab2" class="h-10 rounded-xl text-sm font-semibold border">–ì—Ä—É–ø–ø–∞ 2</button>
        <button id="tab3" class="h-10 rounded-xl text-sm font-semibold border">–ù–æ—á—å</button>
      </div>

      <div class="flex gap-2">
        <input
          id="search"
          type="number"
          inputmode="numeric"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ ‚Ññ–º–µ—Ç–∫–∏..."
          class="flex-1 h-10 px-3 rounded-xl border border-slate-200 focus:ring-4 focus:ring-blue-100"
        />
        <button
          id="refreshBtn"
          class="h-10 px-4 rounded-xl border border-slate-200 text-sm font-semibold"
        >
          –û–±–Ω–æ–≤–∏—Ç—å
        </button>
      </div>

      <div class="text-xs text-slate-500">
        –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –∫–æ–ª–æ–Ω–∫–µ ‚Äú‚Ññ–º–µ—Ç–∫–∏‚Äù. –¢–∞–±–ª–∏—Ü—É –º–æ–∂–Ω–æ –ª–∏—Å—Ç–∞—Ç—å –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏.
      </div>

      <div id="hint" class="hidden text-xs text-slate-500"></div>
    </div>
  </div>
</header>

<main class="max-w-6xl mx-auto px-3 sm:px-4 py-4">
  <div id="status" class="hidden mb-3 text-sm text-slate-600"></div>

  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
    <div class="x-scroll overflow-x-auto">
      <table class="min-w-full text-sm">
        <thead id="thead" class="bg-slate-50"></thead>
        <tbody id="tbody" class="divide-y divide-slate-100"></tbody>
      </table>
    </div>
  </div>
</main>

<script>
  const SHEET_ID = "1CU56AZdWC9dCvkf_z6CWMtrgfuWRCG3HYx7hp79vI_c";
  const SHEET_NAME = "–î–ª—è –ø–µ—á–∞—Ç–∏üñ®Ô∏è";

  // —Ç–≤–æ–∏ –¥–∏–∞–ø–∞–∑–æ–Ω—ã
  const GROUPS = {
    1: "D2:M150",
    2: "R2:Z150",
    3: "AE2:AM150"
  };

  let currentGroup = 1;
  let headers = [];
  let rows = [];
  let labelIndex = -1;

  const tab1 = document.getElementById("tab1");
  const tab2 = document.getElementById("tab2");
  const tab3 = document.getElementById("tab3");
  const searchEl = document.getElementById("search");
  const refreshBtn = document.getElementById("refreshBtn");
  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");
  const statusEl = document.getElementById("status");
  const hintEl = document.getElementById("hint");

  function applyTabs(active){
    [tab1, tab2, tab3].forEach((b,i)=>{
      if(i+1===active){
        b.style.background = "var(--brand-blue)";
        b.style.color = "white";
      } else {
        b.style.background = "";
        b.style.color = "";
      }
    });
  }

  function setStatus(text){
    statusEl.classList.remove("hidden");
    statusEl.textContent = text;
  }
  function clearStatus(){
    statusEl.classList.add("hidden");
    statusEl.textContent = "";
  }

  function setHint(text){
    if (!text) { hintEl.classList.add("hidden"); hintEl.textContent = ""; return; }
    hintEl.classList.remove("hidden");
    hintEl.textContent = text;
  }

  function norm(s){
    return String(s ?? "")
      .toLowerCase()
      .replaceAll(" ", "")
      .replaceAll("\u00A0","");
  }

  // –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π —Ç–µ–∫—Å—Ç
  // –í–ê–ñ–ù–û: true/false –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ –±—É–¥–µ–º (–±—É–¥—É—Ç –ø—É—Å—Ç—ã–µ)
  function cellText(v){
    if (v === true || v === false) return "";
    if (v === null || v === undefined) return "";
    return String(v);
  }

  function isIntLike(s){
    if (s === null || s === undefined) return false;
    const t = String(s).trim();
    if (!t) return false;
    // —Ä–∞–∑—Ä–µ—à–∏–º "003", "3", "99" –∏ —Ç.–ø.
    return /^[0-9]+$/.test(t);
  }

  function detectLabelIndex() {
    // 1) –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É
    const target = norm("‚Ññ–º–µ—Ç–∫–∏");
    let idx = headers.findIndex(h => norm(h) === target);

    // 2) –º—è–≥–∫–∏–π –ø–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É (–µ—Å–ª–∏ —Ç–∞–º "‚Ññ –º–µ—Ç–∫–∏" –∏ —Ç.–ø.)
    if (idx === -1) {
      idx = headers.findIndex(h => {
        const nh = norm(h);
        return nh.includes("–º–µ—Ç–∫") && (nh.includes("‚Ññ") || nh.includes("no") || nh.includes("–Ω–æ–º–µ—Ä"));
      });
    }

    // 3) –µ—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –Ω–µ—Ç/–Ω–µ —Å–æ–≤–ø–∞–ª ‚Äî –∞–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –¥–∞–Ω–Ω—ã–º:
    // –≤—ã–±–∏—Ä–∞–µ–º –∫–æ–ª–æ–Ω–∫—É, –≥–¥–µ –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª (—ç—Ç–æ –æ–±—ã—á–Ω–æ –∏ –µ—Å—Ç—å ‚Ññ–º–µ—Ç–∫–∏)
    if (idx === -1 && rows.length) {
      const colCount = headers.length || (rows[0] ? rows[0].length : 0);
      const scores = new Array(colCount).fill(0);

      for (const r of rows) {
        for (let c = 0; c < colCount; c++) {
          const v = cellText(r[c]);
          if (isIntLike(v)) scores[c] += 1;
        }
      }

      let best = -1, bestScore = 0;
      for (let c = 0; c < scores.length; c++) {
        if (scores[c] > bestScore) { bestScore = scores[c]; best = c; }
      }

      // –ø–æ—Ä–æ–≥: —Ö–æ—Ç—è –±—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–∏—Å–ª–æ–≤—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π, —á—Ç–æ–±—ã –Ω–µ –æ—à–∏–±–∏—Ç—å—Å—è
      if (best !== -1 && bestScore >= 3) idx = best;
    }

    labelIndex = idx;

    if (labelIndex !== -1) {
      const headerName = headers[labelIndex] ? ` (‚Äú${headers[labelIndex]}‚Äù)` : "";
      setHint(`–ö–æ–ª–æ–Ω–∫–∞ ‚Ññ–º–µ—Ç–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞: ${labelIndex + 1}${headerName}`);
    } else {
      setHint('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É ‚Äú‚Ññ–º–µ—Ç–∫–∏‚Äù.');
    }
  }

  async function loadGroup(n){
    currentGroup = n;
    applyTabs(n);
    searchEl.value = "";
    setStatus("–ó–∞–≥—Ä—É–∑–∫–∞...");

    const range = GROUPS[n];
    const url =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?` +
      `sheet=${encodeURIComponent(SHEET_NAME)}&range=${encodeURIComponent(range)}&headers=1`;

    try{
      const res = await fetch(url);
      const text = await res.text();
      const json = JSON.parse(text.substring(47).slice(0,-2));
      const table = json.table;

      headers = table.cols.map(c => cellText(c.label || ""));
      rows = table.rows.map(r => (r.c || []).map(c => cellText(c ? c.v : "")));

      detectLabelIndex();
      clearStatus();
      renderFiltered();
    } catch (e) {
      console.error(e);
      setStatus("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö");
    }
  }

  function renderFiltered(){
    const q = String(searchEl.value || "").trim();
    let filtered = rows;

    // –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–≥–æ –ø–æ –∫–æ–ª–æ–Ω–∫–µ ‚Ññ–º–µ—Ç–∫–∏
    if (q && labelIndex !== -1) {
      filtered = rows.filter(r => String(r[labelIndex] ?? "").trim() === q);
      // –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ ‚Äî –ø–æ–º–µ–Ω—è–µ–º –Ω–∞ includes(q)
    }

    renderTable(filtered);
  }

  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderTable(data){
    thead.innerHTML = `
      <tr>
        ${headers.map(h=>`
          <th class="px-3 py-3 text-left font-semibold border-b whitespace-nowrap">
            ${escapeHtml(h || "‚Äî")}
          </th>`).join("")}
      </tr>
    `;

    if (!data.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="${Math.max(headers.length,1)}" class="px-3 py-10 text-center text-slate-500">
            –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = data.map((row,i)=>`
      <tr class="${i%2?'bg-slate-50':''}">
        ${headers.map((_,j)=>`
          <td class="px-3 py-3 whitespace-nowrap">
            ${escapeHtml(row[j] ?? "")}
          </td>`).join("")}
      </tr>
    `).join("");
  }

  tab1.onclick = ()=>loadGroup(1);
  tab2.onclick = ()=>loadGroup(2);
  tab3.onclick = ()=>loadGroup(3);
  searchEl.oninput = renderFiltered;
  refreshBtn.onclick = ()=>loadGroup(currentGroup);

  applyTabs(1);
  loadGroup(1);
</script>

</body>
</html>
